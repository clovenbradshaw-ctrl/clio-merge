<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Clio → Airtable Merger</title>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
const { useState, useCallback } = React;

// Constants
const ANDREW_BAHR_RECORD_ID = 'recRaQ8cur6na6kIw';

// State-machine CSV Parser - handles multiline quoted fields correctly
const parseCSV = (text) => {
  if (!text || !text.trim()) return { headers: [], rows: [] };

  const rows = [];
  let currentRow = [];
  let currentField = '';
  let inQuotes = false;

  for (let i = 0; i < text.length; i++) {
    const char = text[i];
    const nextChar = text[i + 1];

    if (inQuotes) {
      if (char === '"' && nextChar === '"') {
        currentField += '"';
        i++;
      } else if (char === '"') {
        inQuotes = false;
      } else {
        currentField += char;
      }
    } else {
      if (char === '"') {
        inQuotes = true;
      } else if (char === ',') {
        currentRow.push(currentField.trim());
        currentField = '';
      } else if (char === '\n' || (char === '\r' && nextChar === '\n')) {
        currentRow.push(currentField.trim());
        currentField = '';
        if (currentRow.some(f => f !== '')) {
          rows.push([...currentRow]);
        }
        currentRow = [];
        if (char === '\r' && nextChar === '\n') {
          i++;
        }
      } else if (char === '\r') {
        currentRow.push(currentField.trim());
        currentField = '';
        if (currentRow.some(f => f !== '')) {
          rows.push([...currentRow]);
        }
        currentRow = [];
      } else {
        currentField += char;
      }
    }
  }

  if (currentField !== '' || currentRow.length > 0) {
    currentRow.push(currentField.trim());
    if (currentRow.some(f => f !== '')) {
      rows.push(currentRow);
    }
  }

  if (rows.length === 0) return { headers: [], rows: [] };

  const headers = rows[0];
  const dataRows = rows.slice(1).map(row => {
    const obj = {};
    headers.forEach((h, i) => obj[h] = row[i] || '');
    return obj;
  });

  return { headers, rows: dataRows };
};

// Normalize A# to ###-###-### format
const normalizeANumber = (aNum) => {
  if (!aNum || !aNum.trim()) {
    return { normalized: '', isValid: false, original: aNum, issue: 'empty' };
  }

  const digits = aNum.replace(/[^0-9]/g, '');

  if (digits.length === 9) {
    return {
      normalized: `${digits.slice(0, 3)}-${digits.slice(3, 6)}-${digits.slice(6, 9)}`,
      isValid: true,
      original: aNum,
      issue: null
    };
  }

  if (digits.length === 10 && digits[0] === '1') {
    return {
      normalized: `${digits.slice(1, 4)}-${digits.slice(4, 7)}-${digits.slice(7, 10)}`,
      isValid: true,
      original: aNum,
      issue: null
    };
  }

  return {
    normalized: digits,
    isValid: false,
    original: aNum,
    issue: `wrong-length-${digits.length}`
  };
};

// Generate fallback ID for clients without valid A#
const generateFallbackId = (lastName, firstName, dob) => {
  const cleanLast = (lastName || '').toUpperCase().replace(/[^A-Z]/g, '').slice(0, 10);
  const cleanFirst = (firstName || '').toUpperCase().replace(/[^A-Z]/g, '').slice(0, 10);
  const cleanDob = (dob || '').replace(/[^0-9]/g, '').slice(0, 8);

  if (!cleanLast && !cleanFirst) return null;

  return `PENDING-${cleanLast}-${cleanFirst}${cleanDob ? '-' + cleanDob : ''}`;
};

// Normalize name for matching
const normalizeName = (lastName, firstName) => {
  const clean = (s) => (s || '').toUpperCase().trim().replace(/[^A-Z\s]/g, '');
  return `${clean(lastName)}|${clean(firstName)}`;
};

// Extract A# from text
const extractANumber = (text) => {
  if (!text) return null;

  const patterns = [
    /\|A-?(\d{3})-?(\d{3})-?(\d{3})/i,
    /A-Number:?\s*(\d{3})-?(\d{3})-?(\d{3})/i,
    /A#\s*:?\s*(\d{3})-?(\d{3})-?(\d{3})/i,
    /\bA-(\d{3})-?(\d{3})-?(\d{3})\b/i,
    /\b(\d{3})-?(\d{3})-?(\d{3})\b/,
  ];

  for (const pattern of patterns) {
    const match = text.match(pattern);
    if (match) {
      const digits = match.slice(1).join('').replace(/\D/g, '');
      if (digits.length === 9) {
        return `${digits.slice(0, 3)}-${digits.slice(3, 6)}-${digits.slice(6, 9)}`;
      }
    }
  }
  return null;
};

// Parse event summary
const parseEventSummary = (summary) => {
  if (!summary) return { hearingType: '', clientName: '', aNumber: null, status: '', court: '', matterId: '' };

  const result = { hearingType: '', clientName: '', aNumber: null, status: '', court: '', matterId: '' };
  let working = summary;

  result.aNumber = extractANumber(working);

  working = working
    .replace(/\|A-?Number:?\s*\d{3}-?\d{3}-?\d{3}/gi, '')
    .replace(/\|A-?\d{3}-?\d{3}-?\d{3}/gi, '')
    .replace(/A-Number:?\s*\d{3}-?\d{3}-?\d{3}/gi, '')
    .replace(/A#\s*:?\s*\d{3}-?\d{3}-?\d{3}/gi, '')
    .replace(/\bA-\d{3}-?\d{3}-?\d{3}\b/gi, '');

  // Extract matter ID (in parentheses like "00026-Mendez Alvarado")
  const matterMatch = working.match(/\((\d{4,}-[^)]+)\)/);
  if (matterMatch) {
    result.matterId = matterMatch[1];
    working = working.replace(matterMatch[0], '').trim();
  }

  // Extract hearing type
  const HEARING_TYPES = ['MASTER', 'MCH', 'INDIVIDUAL', 'ICH', 'BOND', 'STATUS', 'CUSTODY', 'CALENDAR'];
  for (const typeKw of HEARING_TYPES) {
    if (working.toUpperCase().includes(typeKw)) {
      result.hearingType = typeKw;
      break;
    }
  }

  return result;
};

// Parse event description
const parseEventDescription = (desc) => {
  if (!desc) return { judge: '', courtAddress: '' };

  const result = { judge: '', courtAddress: '' };

  const judgeMatch = desc.match(/JUDGE[:\s]+([A-Za-z][^\n|]+)/i);
  if (judgeMatch) {
    result.judge = judgeMatch[1].trim().replace(/\s*(COURT|ADDRESS|RIDER).*$/i, '').trim();
  }

  const addressMatch = desc.match(/COURT\s*ADDRESS[:\s]+([^\n]+)/i);
  if (addressMatch) {
    result.courtAddress = addressMatch[1].trim();
  }

  return result;
};

// Map hearing type from Clio to Airtable
const mapHearingType = (clioType) => {
  const mapping = {
    'MASTER': 'Master',
    'INDIVIDUAL': 'Individual',
    'ICH': 'Individual',
    'MCH': 'Master',
    'BOND': 'Bond',
    'STATUS': 'Status Docket',
  };
  return mapping[clioType?.toUpperCase()] || clioType;
};

// Generate CSV string from data
const generateCSV = (headers, rows) => {
  const escapeField = (field) => {
    const str = String(field ?? '');
    if (str.includes(',') || str.includes('"') || str.includes('\n')) {
      return `"${str.replace(/"/g, '""')}"`;
    }
    return str;
  };

  const headerRow = headers.map(escapeField).join(',');
  const dataRows = rows.map(row => headers.map(h => escapeField(row[h])).join(','));
  return [headerRow, ...dataRows].join('\n');
};

// Main App Component
function ClioAirtableMerger() {
  const [activePhase, setActivePhase] = useState(1);

  // Phase 1 state
  const [phase1Files, setPhase1Files] = useState({ bahr: null, clioContacts: null });
  const [phase1Data, setPhase1Data] = useState({ bahr: null, clioContacts: null });
  const [phase1Result, setPhase1Result] = useState(null);
  const [phase1Report, setPhase1Report] = useState([]);

  // Phase 2 state
  const [phase2Files, setPhase2Files] = useState({ airtableClients: null, clioMatters: null, clioNotes: null });
  const [phase2Data, setPhase2Data] = useState({ airtableClients: null, clioMatters: null, clioNotes: null });
  const [phase2Result, setPhase2Result] = useState(null);
  const [phase2Report, setPhase2Report] = useState([]);

  // Phase 3 state
  const [phase3Files, setPhase3Files] = useState({
    airtableClients: null,
    airtableCaseMaster: null,
    clioEvents: null,
    clioRelationships: null
  });
  const [phase3Data, setPhase3Data] = useState({
    airtableClients: null,
    airtableCaseMaster: null,
    clioEvents: null,
    clioRelationships: null
  });
  const [phase3Result, setPhase3Result] = useState(null);
  const [phase3Report, setPhase3Report] = useState([]);

  const handleFileUpload = (phase, type) => (event) => {
    const file = event.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = (e) => {
      const text = e.target.result;
      const parsed = parseCSV(text);

      if (phase === 1) {
        setPhase1Files(prev => ({ ...prev, [type]: file }));
        setPhase1Data(prev => ({ ...prev, [type]: parsed }));
      } else if (phase === 2) {
        setPhase2Files(prev => ({ ...prev, [type]: file }));
        setPhase2Data(prev => ({ ...prev, [type]: parsed }));
      } else if (phase === 3) {
        setPhase3Files(prev => ({ ...prev, [type]: file }));
        setPhase3Data(prev => ({ ...prev, [type]: parsed }));
      }
    };
    reader.readAsText(file);
  };

  // Phase 1: Client Import
  const runPhase1 = useCallback(() => {
    const reports = [];
    const bahrLookup = new Map();
    const clientsOutput = [];

    let validANumbers = 0;
    let invalidANumbers = 0;
    let missingANumbers = 0;

    // Build Bahr lookup
    if (phase1Data.bahr?.rows) {
      phase1Data.bahr.rows.forEach((row, idx) => {
        const lastName = row['Last Name'] || '';
        const firstName = row['First Name'] || '';
        const middleName = row['Middle Name'] || '';
        const dob = row['DOB'] || '';
        const rawANumber = row['A number'] || '';

        const aNumberResult = normalizeANumber(rawANumber);
        const nameKey = normalizeName(lastName, firstName);

        let clientId = '';
        let aNumberStatus = '';

        if (aNumberResult.isValid) {
          clientId = aNumberResult.normalized;
          aNumberStatus = 'valid';
          validANumbers++;
        } else if (aNumberResult.issue === 'empty') {
          clientId = generateFallbackId(lastName, firstName, dob) || `PENDING-ROW-${idx}`;
          aNumberStatus = 'missing';
          missingANumbers++;
        } else {
          clientId = generateFallbackId(lastName, firstName, dob) || `PENDING-ROW-${idx}`;
          aNumberStatus = 'invalid';
          invalidANumbers++;
          reports.push({
            type: 'warning',
            message: `Row ${idx + 2} (${firstName} ${lastName}): Invalid A# "${rawANumber}"`
          });
        }

        const record = {
          _nameKey: nameKey,
          _clientId: clientId,
          _aNumberStatus: aNumberStatus,
          lastName,
          firstName,
          middleName,
          aNumber: aNumberResult.isValid ? aNumberResult.normalized : '',
          phone: row['Telphone Number'] || '',
          email: row['Email'] || '',
          addressLine1: row['Street Number and Name'] || '',
          addressLine2: [row['Address line 2'], row['AptSte'], row['FlrNumber']].filter(Boolean).join(' '),
          state: row['State'] || '',
          city: row['City'] || '',
          zip: row['zipcode'] || '',
          country: row['18.a. Country of Citizenship or Nationality'] || '',
          entryDate: row['22. Date of Last Arrival into United States'] || '',
          placeOfEntry: row['23. Place of Last Arrival to US'] || '',
          dob: dob,
          clioContactId: '', // Will be populated from Clio Contacts
        };

        bahrLookup.set(nameKey, record);
      });
    }

    reports.push({ type: 'info', message: `Loaded ${bahrLookup.size} clients from Bahr dataset` });
    reports.push({
      type: validANumbers === bahrLookup.size ? 'success' : 'warning',
      message: `A# Validation: ${validANumbers} valid, ${invalidANumbers} malformed, ${missingANumbers} missing`
    });

    // Enrich with Clio Contacts
    let contactMatches = 0;
    let contactMisses = 0;

    if (phase1Data.clioContacts?.rows) {
      phase1Data.clioContacts.rows.forEach((row) => {
        const lastName = row['Last Name'] || '';
        const firstName = row['First Name'] || '';
        const nameKey = normalizeName(lastName, firstName);

        if (bahrLookup.has(nameKey)) {
          const record = bahrLookup.get(nameKey);
          if (!record.phone && row['Mobile Phone']) record.phone = row['Mobile Phone'];
          if (!record.phone && row['Primary Phone']) record.phone = row['Primary Phone'];
          if (!record.email && row['E-mail Address']) record.email = row['E-mail Address'];
          record.clioContactId = row['UniqueId'] || '';
          contactMatches++;
        } else {
          contactMisses++;
        }
      });

      reports.push({ type: 'info', message: `Matched ${contactMatches} Clio contacts, ${contactMisses} unmatched` });
    }

    // Build output
    bahrLookup.forEach((record) => {
      clientsOutput.push({
        'Client ID': record._clientId,
        'A#': record.aNumber,
        'First Name': record.firstName,
        'Middle Name': record.middleName,
        'Family Name': record.lastName,
        'Phone Number': record.phone,
        'Client Email': record.email,
        'Address Line 1': record.addressLine1,
        'Address Line 2': record.addressLine2,
        'City': record.city,
        'State': record.state,
        'Zip (5)': record.zip,
        'Country': record.country,
        'Entry Date': record.entryDate,
        'Place of Entry': record.placeOfEntry,
        'DOB': record.dob,
        'clio_contact_id': record.clioContactId,
        'ICH Atty': ANDREW_BAHR_RECORD_ID,
        'Bahr Client': 'TRUE',
      });
    });

    setPhase1Result({ clients: clientsOutput });
    setPhase1Report(reports);
  }, [phase1Data]);

  // Phase 2: Case Master Views
  const runPhase2 = useCallback(() => {
    const reports = [];

    // Build clio_contact_id -> Airtable Record ID lookup from Airtable export
    const clioContactToRecordId = new Map();
    const clientIdToRecordId = new Map();

    if (phase2Data.airtableClients?.rows) {
      phase2Data.airtableClients.rows.forEach((row) => {
        const recordId = row['Record ID'] || row['recordId'] || row['Airtable Record ID'] || '';
        const clioContactId = row['clio_contact_id'] || '';
        const clientId = row['Client ID'] || row['A#'] || '';

        if (clioContactId && recordId) {
          clioContactToRecordId.set(clioContactId, recordId);
        }
        if (clientId && recordId) {
          clientIdToRecordId.set(clientId, recordId);
        }
      });
      reports.push({ type: 'info', message: `Loaded ${clioContactToRecordId.size} clio_contact_id mappings from Airtable export` });
    }

    // Build MatterId -> Matter info lookup from Clio Matters
    const mattersLookup = new Map();

    if (phase2Data.clioMatters?.rows) {
      phase2Data.clioMatters.rows.forEach((row) => {
        const matterId = row['UniqueId'] || '';
        const clientId = row['ClientId'] || '';
        const displayNumber = row['DisplayNumber'] || '';
        const description = row['Description'] || '';
        const client = row['Client'] || '';
        const status = row['Status'] || '';
        const openDate = row['OpenDate'] || '';
        const closeDate = row['CloseDate'] || '';

        if (matterId) {
          mattersLookup.set(matterId, {
            matterId,
            clientId, // This is the clio_contact_id
            displayNumber,
            description,
            clientName: client,
            status,
            openDate,
            closeDate,
            notes: [],
          });
        }
      });
      reports.push({ type: 'info', message: `Loaded ${mattersLookup.size} matters from Clio Matters` });
    }

    // Aggregate notes by MatterId
    let notesMatched = 0;
    let notesUnmatched = 0;

    if (phase2Data.clioNotes?.rows) {
      phase2Data.clioNotes.rows.forEach((row) => {
        const matterId = row['MatterId'] || '';
        const subject = row['Subject'] || '';
        const detail = row['Detail'] || '';
        const date = row['Date'] || row['CreatedAt'] || '';
        const creator = row['Creator'] || '';

        if (mattersLookup.has(matterId)) {
          mattersLookup.get(matterId).notes.push({ date, subject, detail, creator });
          notesMatched++;
        } else {
          notesUnmatched++;
        }
      });
      reports.push({ type: 'info', message: `Matched ${notesMatched} notes, ${notesUnmatched} unmatched` });
    }

    // Build Case Master View output
    const caseMasterOutput = [];
    let linkedCount = 0;
    let unlinkedCount = 0;

    mattersLookup.forEach((matter) => {
      // Find Airtable Record ID for this client
      const clientRecordId = clioContactToRecordId.get(matter.clientId) || '';

      if (clientRecordId) {
        linkedCount++;
      } else {
        unlinkedCount++;
        reports.push({ type: 'warning', message: `Matter ${matter.displayNumber} - client not found in Airtable export (ClientId: ${matter.clientId})` });
      }

      // Sort notes by date descending and format
      const sortedNotes = matter.notes.sort((a, b) => new Date(b.date || 0) - new Date(a.date || 0));

      const formattedNotes = sortedNotes.map((note) => {
        const datePart = note.date ? `[${note.date}]` : '[No Date]';
        const subjectPart = note.subject ? ` - ${note.subject}` : '';
        const creatorPart = note.creator ? `\nBy: ${note.creator}` : '';
        return `${'═'.repeat(55)}\n${datePart}${subjectPart}${creatorPart}\n${'─'.repeat(50)}\n${note.detail || '(No content)'}`;
      }).join('\n\n');

      caseMasterOutput.push({
        'Client': clientRecordId, // Airtable link field
        'clio_matter_id': matter.matterId,
        'PP ID': matter.displayNumber,
        'Description': matter.description,
        'File Case Status': matter.status === 'Open' ? 'Active' : matter.status,
        'Case Notes': formattedNotes,
        'Bahr Client': 'TRUE',
        '_client_name': matter.clientName,
        '_note_count': sortedNotes.length,
      });
    });

    reports.push({ type: 'info', message: `Generated ${caseMasterOutput.length} Case Master Views (${linkedCount} linked, ${unlinkedCount} unlinked)` });

    setPhase2Result({ caseMaster: caseMasterOutput });
    setPhase2Report(reports);
  }, [phase2Data]);

  // Phase 3: Events & Relationships
  const runPhase3 = useCallback(() => {
    const reports = [];

    // Build lookups from Airtable exports
    const clioContactToRecordId = new Map();
    const clioMatterToRecordId = new Map();
    const displayNumberToRecordId = new Map();

    if (phase3Data.airtableClients?.rows) {
      phase3Data.airtableClients.rows.forEach((row) => {
        const recordId = row['Record ID'] || row['recordId'] || '';
        const clioContactId = row['clio_contact_id'] || '';
        if (clioContactId && recordId) {
          clioContactToRecordId.set(clioContactId, recordId);
        }
      });
      reports.push({ type: 'info', message: `Loaded ${clioContactToRecordId.size} client mappings` });
    }

    if (phase3Data.airtableCaseMaster?.rows) {
      phase3Data.airtableCaseMaster.rows.forEach((row) => {
        const recordId = row['Record ID'] || row['recordId'] || '';
        const clioMatterId = row['clio_matter_id'] || '';
        const displayNumber = row['PP ID'] || '';

        if (clioMatterId && recordId) {
          clioMatterToRecordId.set(clioMatterId, recordId);
        }
        if (displayNumber && recordId) {
          // Extract just the number part for matching (e.g., "00006" from "00006-Hernandez")
          const numMatch = displayNumber.match(/^(\d+)/);
          if (numMatch) {
            displayNumberToRecordId.set(numMatch[1], recordId);
          }
          displayNumberToRecordId.set(displayNumber, recordId);
        }
      });
      reports.push({ type: 'info', message: `Loaded ${clioMatterToRecordId.size} case master mappings` });
    }

    // Process Events
    const eventsOutput = [];
    let eventsLinked = 0;
    let eventsUnlinked = 0;

    if (phase3Data.clioEvents?.rows) {
      phase3Data.clioEvents.rows.forEach((row) => {
        const summary = row['summary'] || '';
        const description = row['description'] || '';
        const startDateTime = row['start.dateTime'] || '';
        const location = row['location'] || '';

        const summaryParsed = parseEventSummary(summary);
        const descParsed = parseEventDescription(description);

        // Skip events without A#
        if (!summaryParsed.aNumber) {
          reports.push({ type: 'warning', message: `Event skipped (no A#): ${summary.slice(0, 50)}...` });
          return;
        }

        // Try to find Case Master View by matter ID from summary
        let caseMasterRecordId = '';
        if (summaryParsed.matterId) {
          // Try full match first
          caseMasterRecordId = displayNumberToRecordId.get(summaryParsed.matterId) || '';

          // Try just the number part
          if (!caseMasterRecordId) {
            const numMatch = summaryParsed.matterId.match(/^(\d+)/);
            if (numMatch) {
              caseMasterRecordId = displayNumberToRecordId.get(numMatch[1]) || '';
            }
          }
        }

        if (caseMasterRecordId) {
          eventsLinked++;
        } else {
          eventsUnlinked++;
          reports.push({ type: 'warning', message: `Event not linked to Case Master: ${summaryParsed.matterId || 'no matter ID'}` });
        }

        const court = location || descParsed.courtAddress || '';

        eventsOutput.push({
          'Case Master': caseMasterRecordId, // Link to Case Master View
          'A#': summaryParsed.aNumber,
          'Hearing Date/Time': startDateTime,
          'Event Type': 'Hearing',
          'Event Hearing Type': mapHearingType(summaryParsed.hearingType),
          'Court': court,
          'Judge': descParsed.judge,
          'MCH Attny': ANDREW_BAHR_RECORD_ID,
          'Bahr Client': 'TRUE',
          '_summary': summary.slice(0, 100),
        });
      });

      reports.push({ type: 'info', message: `Processed ${eventsOutput.length} events (${eventsLinked} linked, ${eventsUnlinked} unlinked)` });
    }

    // Process Relationships
    const relationshipsOutput = [];
    let relsLinked = 0;
    let relsUnlinked = 0;

    if (phase3Data.clioRelationships?.rows) {
      phase3Data.clioRelationships.rows.forEach((row) => {
        const relationshipDesc = row['RelationshipDescription'] || '';
        const contactId = row['ContactId'] || ''; // Object client (the related person)
        const matterId = row['MatterId'] || '';
        const contactName = row['Contact'] || '';

        // Find the subject client (primary client on the matter) - we need to look this up from the matter
        // For now, we'll use the Case Master View link
        const caseMasterRecordId = clioMatterToRecordId.get(matterId) || '';
        const objectClientRecordId = clioContactToRecordId.get(contactId) || '';

        if (caseMasterRecordId && objectClientRecordId) {
          relsLinked++;
        } else {
          relsUnlinked++;
          if (!caseMasterRecordId) {
            reports.push({ type: 'warning', message: `Relationship: Case Master not found for matter ${matterId}` });
          }
          if (!objectClientRecordId) {
            reports.push({ type: 'warning', message: `Relationship: Object client not found (${contactName}, ID: ${contactId})` });
          }
        }

        // Map relationship description to Airtable select options
        const relationshipMap = {
          'spouse': 'Spouse',
          'son': 'Child',
          'daughter': 'Child',
          'parent': 'Parent',
          'mother': 'Parent',
          'father': 'Parent',
          'sibling': 'Sibling',
          'brother': 'Sibling',
          'sister': 'Sibling',
        };
        const relationship = relationshipMap[relationshipDesc.toLowerCase()] || relationshipDesc;

        relationshipsOutput.push({
          'Case Master View': caseMasterRecordId,
          'Object Client': objectClientRecordId,
          'Relationship': relationship,
          'Bahr Client': 'TRUE',
          '_contact_name': contactName,
          '_original_relationship': relationshipDesc,
        });
      });

      reports.push({ type: 'info', message: `Processed ${relationshipsOutput.length} relationships (${relsLinked} linked, ${relsUnlinked} unlinked)` });
    }

    setPhase3Result({ events: eventsOutput, relationships: relationshipsOutput });
    setPhase3Report(reports);
  }, [phase3Data]);

  const downloadCSV = (data, filename, headers) => {
    const csv = generateCSV(headers, data);
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    a.click();
    URL.revokeObjectURL(url);
  };

  return (
    <div style={{
      minHeight: '100vh',
      background: 'linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%)',
      fontFamily: "'JetBrains Mono', 'Fira Code', monospace",
      color: '#e4e4e7',
      padding: '2rem',
    }}>
      <style>{`
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&display=swap');
        * { box-sizing: border-box; }
        .card {
          background: rgba(255, 255, 255, 0.03);
          border: 1px solid rgba(255, 255, 255, 0.08);
          border-radius: 12px;
          padding: 1.5rem;
          backdrop-filter: blur(10px);
        }
        .upload-zone {
          border: 2px dashed rgba(99, 102, 241, 0.4);
          border-radius: 8px;
          padding: 1.5rem;
          text-align: center;
          cursor: pointer;
          transition: all 0.2s;
        }
        .upload-zone:hover {
          border-color: rgba(99, 102, 241, 0.8);
          background: rgba(99, 102, 241, 0.05);
        }
        .upload-zone.has-file {
          border-color: #22c55e;
          background: rgba(34, 197, 94, 0.1);
        }
        .btn {
          padding: 0.75rem 1.5rem;
          border-radius: 8px;
          font-weight: 600;
          font-size: 0.875rem;
          cursor: pointer;
          transition: all 0.2s;
          border: none;
          font-family: inherit;
        }
        .btn-primary {
          background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
          color: white;
        }
        .btn-primary:hover:not(:disabled) {
          transform: translateY(-2px);
          box-shadow: 0 4px 20px rgba(99, 102, 241, 0.4);
        }
        .btn-primary:disabled {
          opacity: 0.5;
          cursor: not-allowed;
        }
        .btn-secondary {
          background: rgba(255, 255, 255, 0.1);
          color: #e4e4e7;
          border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .btn-secondary:hover {
          background: rgba(255, 255, 255, 0.15);
        }
        .phase-tab {
          padding: 1rem 1.5rem;
          cursor: pointer;
          border-radius: 8px 8px 0 0;
          transition: all 0.2s;
          color: #a1a1aa;
          background: rgba(255, 255, 255, 0.02);
          border: 1px solid transparent;
          border-bottom: none;
        }
        .phase-tab:hover { color: #e4e4e7; }
        .phase-tab.active {
          color: #6366f1;
          background: rgba(99, 102, 241, 0.1);
          border-color: rgba(99, 102, 241, 0.3);
        }
        .badge {
          display: inline-block;
          padding: 0.25rem 0.5rem;
          border-radius: 4px;
          font-size: 0.75rem;
          font-weight: 600;
        }
        .badge-info { background: rgba(59, 130, 246, 0.2); color: #60a5fa; }
        .badge-warning { background: rgba(245, 158, 11, 0.2); color: #fbbf24; }
        .badge-error { background: rgba(239, 68, 68, 0.2); color: #f87171; }
        .badge-success { background: rgba(34, 197, 94, 0.2); color: #4ade80; }
        .table-container { overflow-x: auto; margin-top: 1rem; }
        table { width: 100%; border-collapse: collapse; font-size: 0.8rem; }
        th, td { padding: 0.5rem; text-align: left; border-bottom: 1px solid rgba(255, 255, 255, 0.1); }
        th { background: rgba(99, 102, 241, 0.1); font-weight: 600; color: #a5b4fc; }
        td { color: #d4d4d8; }
      `}</style>

      <div style={{ maxWidth: '1200px', margin: '0 auto' }}>
        <header style={{ marginBottom: '2rem', textAlign: 'center' }}>
          <h1 style={{
            fontSize: '2rem',
            fontWeight: '700',
            background: 'linear-gradient(135deg, #6366f1 0%, #a855f7 50%, #ec4899 100%)',
            WebkitBackgroundClip: 'text',
            WebkitTextFillColor: 'transparent',
            marginBottom: '0.5rem',
          }}>
            Clio → Airtable Merger
          </h1>
          <p style={{ color: '#71717a', fontSize: '0.875rem' }}>
            3-Phase import: Clients → Case Master Views → Events & Relationships
          </p>
        </header>

        {/* Phase Tabs */}
        <div style={{ display: 'flex', gap: '0.5rem', marginBottom: '0' }}>
          {[
            { num: 1, label: 'Phase 1: Clients', desc: 'Bahr + Clio Contacts' },
            { num: 2, label: 'Phase 2: Case Master', desc: 'Matters + Notes' },
            { num: 3, label: 'Phase 3: Events & Relationships', desc: 'Events + Related Contacts' },
          ].map(({ num, label, desc }) => (
            <div
              key={num}
              className={`phase-tab ${activePhase === num ? 'active' : ''}`}
              onClick={() => setActivePhase(num)}
            >
              <div style={{ fontWeight: 600 }}>{label}</div>
              <div style={{ fontSize: '0.75rem', color: '#71717a' }}>{desc}</div>
            </div>
          ))}
        </div>

        {/* Phase Content */}
        <div className="card" style={{ borderTopLeftRadius: 0 }}>
          {/* Phase 1: Clients */}
          {activePhase === 1 && (
            <div>
              <h2 style={{ marginBottom: '1rem', fontSize: '1.25rem' }}>Phase 1: Client Import</h2>
              <p style={{ color: '#71717a', marginBottom: '1.5rem', fontSize: '0.875rem' }}>
                Merge Bahr dataset with Clio Contacts. Output includes <code>clio_contact_id</code>, <code>ICH Atty</code>, and <code>Bahr Client</code> fields.
              </p>

              <div style={{ display: 'grid', gridTemplateColumns: 'repeat(2, 1fr)', gap: '1rem', marginBottom: '1.5rem' }}>
                {[
                  { key: 'bahr', label: 'Bahr Dataset', desc: 'Authority source with A# and demographics', required: true },
                  { key: 'clioContacts', label: 'Clio Contacts Export', desc: 'UniqueId, phone, email', required: true },
                ].map(({ key, label, desc, required }) => (
                  <div key={key}>
                    <h4 style={{ fontSize: '0.875rem', marginBottom: '0.5rem', display: 'flex', alignItems: 'center', gap: '0.5rem' }}>
                      {label}
                      {required && <span className="badge badge-warning">Required</span>}
                    </h4>
                    <p style={{ fontSize: '0.75rem', color: '#71717a', marginBottom: '0.5rem' }}>{desc}</p>
                    <label className={`upload-zone ${phase1Files[key] ? 'has-file' : ''}`}>
                      <input type="file" accept=".csv" onChange={handleFileUpload(1, key)} style={{ display: 'none' }} />
                      {phase1Files[key] ? (
                        <div>
                          <span style={{ color: '#22c55e' }}>✓</span> {phase1Files[key].name}
                          <div style={{ fontSize: '0.75rem', color: '#71717a' }}>{phase1Data[key]?.rows?.length || 0} rows</div>
                        </div>
                      ) : (
                        <div style={{ color: '#71717a' }}>Drop CSV or click to upload</div>
                      )}
                    </label>
                  </div>
                ))}
              </div>

              <button
                className="btn btn-primary"
                onClick={runPhase1}
                disabled={!phase1Data.bahr?.rows?.length}
                style={{ marginBottom: '1.5rem' }}
              >
                Generate clients.csv
              </button>

              {phase1Report.length > 0 && (
                <div style={{ marginBottom: '1.5rem' }}>
                  <h4 style={{ marginBottom: '0.5rem' }}>Validation Report</h4>
                  <div style={{ maxHeight: '150px', overflowY: 'auto', fontSize: '0.8rem' }}>
                    {phase1Report.map((item, i) => (
                      <div key={i} style={{ display: 'flex', gap: '0.5rem', marginBottom: '0.25rem' }}>
                        <span className={`badge badge-${item.type}`}>{item.type}</span>
                        <span>{item.message}</span>
                      </div>
                    ))}
                  </div>
                </div>
              )}

              {phase1Result && (
                <div>
                  <button
                    className="btn btn-secondary"
                    onClick={() => downloadCSV(
                      phase1Result.clients,
                      'phase1_clients.csv',
                      ['Client ID', 'A#', 'First Name', 'Middle Name', 'Family Name', 'Phone Number', 'Client Email', 'Address Line 1', 'Address Line 2', 'City', 'State', 'Zip (5)', 'Country', 'Entry Date', 'Place of Entry', 'DOB', 'clio_contact_id', 'ICH Atty', 'Bahr Client']
                    )}
                  >
                    Download clients.csv ({phase1Result.clients.length} records)
                  </button>

                  <div className="table-container">
                    <table>
                      <thead>
                        <tr>
                          <th>Client ID</th>
                          <th>A#</th>
                          <th>Name</th>
                          <th>clio_contact_id</th>
                          <th>ICH Atty</th>
                        </tr>
                      </thead>
                      <tbody>
                        {phase1Result.clients.slice(0, 5).map((row, i) => (
                          <tr key={i}>
                            <td style={{ fontFamily: 'monospace', fontSize: '0.7rem' }}>{row['Client ID']}</td>
                            <td>{row['A#'] || '—'}</td>
                            <td>{row['First Name']} {row['Family Name']}</td>
                            <td style={{ fontFamily: 'monospace', fontSize: '0.7rem' }}>{row['clio_contact_id'] || '—'}</td>
                            <td style={{ fontFamily: 'monospace', fontSize: '0.7rem' }}>{row['ICH Atty'].slice(0, 10)}...</td>
                          </tr>
                        ))}
                      </tbody>
                    </table>
                  </div>

                  <div style={{ marginTop: '1.5rem', padding: '1rem', background: 'rgba(34, 197, 94, 0.1)', borderRadius: '8px', border: '1px solid rgba(34, 197, 94, 0.3)' }}>
                    <h4 style={{ color: '#4ade80', marginBottom: '0.5rem' }}>Next Steps</h4>
                    <ol style={{ fontSize: '0.875rem', color: '#a1a1aa', paddingLeft: '1.25rem' }}>
                      <li>Import <code>phase1_clients.csv</code> to Airtable Client Info table</li>
                      <li>Export Client Info table (include Record ID and clio_contact_id columns)</li>
                      <li>Proceed to Phase 2 with the export</li>
                    </ol>
                  </div>
                </div>
              )}
            </div>
          )}

          {/* Phase 2: Case Master Views */}
          {activePhase === 2 && (
            <div>
              <h2 style={{ marginBottom: '1rem', fontSize: '1.25rem' }}>Phase 2: Case Master Views</h2>
              <p style={{ color: '#71717a', marginBottom: '1.5rem', fontSize: '0.875rem' }}>
                Create Case Master Views from Clio Matters with aggregated notes. Links to Clients via Airtable Record ID.
              </p>

              <div style={{ display: 'grid', gridTemplateColumns: 'repeat(3, 1fr)', gap: '1rem', marginBottom: '1.5rem' }}>
                {[
                  { key: 'airtableClients', label: 'Airtable Client Export', desc: 'Must include Record ID and clio_contact_id', required: true },
                  { key: 'clioMatters', label: 'Clio Matters Export', desc: 'UniqueId, ClientId, DisplayNumber', required: true },
                  { key: 'clioNotes', label: 'Clio Matter Notes', desc: 'MatterId, Subject, Detail, Date', required: false },
                ].map(({ key, label, desc, required }) => (
                  <div key={key}>
                    <h4 style={{ fontSize: '0.875rem', marginBottom: '0.5rem', display: 'flex', alignItems: 'center', gap: '0.5rem' }}>
                      {label}
                      {required && <span className="badge badge-warning">Required</span>}
                    </h4>
                    <p style={{ fontSize: '0.75rem', color: '#71717a', marginBottom: '0.5rem' }}>{desc}</p>
                    <label className={`upload-zone ${phase2Files[key] ? 'has-file' : ''}`}>
                      <input type="file" accept=".csv" onChange={handleFileUpload(2, key)} style={{ display: 'none' }} />
                      {phase2Files[key] ? (
                        <div>
                          <span style={{ color: '#22c55e' }}>✓</span> {phase2Files[key].name}
                          <div style={{ fontSize: '0.75rem', color: '#71717a' }}>{phase2Data[key]?.rows?.length || 0} rows</div>
                        </div>
                      ) : (
                        <div style={{ color: '#71717a' }}>Drop CSV or click</div>
                      )}
                    </label>
                  </div>
                ))}
              </div>

              <button
                className="btn btn-primary"
                onClick={runPhase2}
                disabled={!phase2Data.airtableClients?.rows?.length || !phase2Data.clioMatters?.rows?.length}
                style={{ marginBottom: '1.5rem' }}
              >
                Generate case_master_views.csv
              </button>

              {phase2Report.length > 0 && (
                <div style={{ marginBottom: '1.5rem' }}>
                  <h4 style={{ marginBottom: '0.5rem' }}>Validation Report</h4>
                  <div style={{ maxHeight: '150px', overflowY: 'auto', fontSize: '0.8rem' }}>
                    {phase2Report.map((item, i) => (
                      <div key={i} style={{ display: 'flex', gap: '0.5rem', marginBottom: '0.25rem' }}>
                        <span className={`badge badge-${item.type}`}>{item.type}</span>
                        <span>{item.message}</span>
                      </div>
                    ))}
                  </div>
                </div>
              )}

              {phase2Result && (
                <div>
                  <button
                    className="btn btn-secondary"
                    onClick={() => downloadCSV(
                      phase2Result.caseMaster,
                      'phase2_case_master_views.csv',
                      ['Client', 'clio_matter_id', 'PP ID', 'Description', 'File Case Status', 'Case Notes', 'Bahr Client', '_client_name', '_note_count']
                    )}
                  >
                    Download case_master_views.csv ({phase2Result.caseMaster.length} records)
                  </button>

                  <div className="table-container">
                    <table>
                      <thead>
                        <tr>
                          <th>Client (Record ID)</th>
                          <th>PP ID</th>
                          <th>Description</th>
                          <th>Notes</th>
                        </tr>
                      </thead>
                      <tbody>
                        {phase2Result.caseMaster.slice(0, 5).map((row, i) => (
                          <tr key={i}>
                            <td style={{ fontFamily: 'monospace', fontSize: '0.7rem' }}>{row['Client'] ? row['Client'].slice(0, 12) + '...' : '—'}</td>
                            <td>{row['PP ID']}</td>
                            <td>{row['Description']?.slice(0, 30)}</td>
                            <td>{row['_note_count']} notes</td>
                          </tr>
                        ))}
                      </tbody>
                    </table>
                  </div>

                  <div style={{ marginTop: '1.5rem', padding: '1rem', background: 'rgba(34, 197, 94, 0.1)', borderRadius: '8px', border: '1px solid rgba(34, 197, 94, 0.3)' }}>
                    <h4 style={{ color: '#4ade80', marginBottom: '0.5rem' }}>Next Steps</h4>
                    <ol style={{ fontSize: '0.875rem', color: '#a1a1aa', paddingLeft: '1.25rem' }}>
                      <li>Import <code>phase2_case_master_views.csv</code> to Airtable Case Master View table</li>
                      <li>Export Case Master View table (include Record ID and clio_matter_id columns)</li>
                      <li>Proceed to Phase 3 with both exports</li>
                    </ol>
                  </div>
                </div>
              )}
            </div>
          )}

          {/* Phase 3: Events & Relationships */}
          {activePhase === 3 && (
            <div>
              <h2 style={{ marginBottom: '1rem', fontSize: '1.25rem' }}>Phase 3: Events & Relationships</h2>
              <p style={{ color: '#71717a', marginBottom: '1.5rem', fontSize: '0.875rem' }}>
                Create Events linked to Case Master Views, and Relationships between clients.
              </p>

              <div style={{ display: 'grid', gridTemplateColumns: 'repeat(2, 1fr)', gap: '1rem', marginBottom: '1.5rem' }}>
                {[
                  { key: 'airtableClients', label: 'Airtable Client Export', desc: 'Record ID + clio_contact_id', required: true },
                  { key: 'airtableCaseMaster', label: 'Airtable Case Master Export', desc: 'Record ID + clio_matter_id + PP ID', required: true },
                  { key: 'clioEvents', label: 'Clio Events Export', desc: 'Google Calendar events', required: false },
                  { key: 'clioRelationships', label: 'Clio Contact Related Matters', desc: 'ContactId, MatterId, RelationshipDescription', required: false },
                ].map(({ key, label, desc, required }) => (
                  <div key={key}>
                    <h4 style={{ fontSize: '0.875rem', marginBottom: '0.5rem', display: 'flex', alignItems: 'center', gap: '0.5rem' }}>
                      {label}
                      {required && <span className="badge badge-warning">Required</span>}
                    </h4>
                    <p style={{ fontSize: '0.75rem', color: '#71717a', marginBottom: '0.5rem' }}>{desc}</p>
                    <label className={`upload-zone ${phase3Files[key] ? 'has-file' : ''}`}>
                      <input type="file" accept=".csv" onChange={handleFileUpload(3, key)} style={{ display: 'none' }} />
                      {phase3Files[key] ? (
                        <div>
                          <span style={{ color: '#22c55e' }}>✓</span> {phase3Files[key].name}
                          <div style={{ fontSize: '0.75rem', color: '#71717a' }}>{phase3Data[key]?.rows?.length || 0} rows</div>
                        </div>
                      ) : (
                        <div style={{ color: '#71717a' }}>Drop CSV or click</div>
                      )}
                    </label>
                  </div>
                ))}
              </div>

              <button
                className="btn btn-primary"
                onClick={runPhase3}
                disabled={!phase3Data.airtableClients?.rows?.length || !phase3Data.airtableCaseMaster?.rows?.length}
                style={{ marginBottom: '1.5rem' }}
              >
                Generate events.csv & relationships.csv
              </button>

              {phase3Report.length > 0 && (
                <div style={{ marginBottom: '1.5rem' }}>
                  <h4 style={{ marginBottom: '0.5rem' }}>Validation Report</h4>
                  <div style={{ maxHeight: '150px', overflowY: 'auto', fontSize: '0.8rem' }}>
                    {phase3Report.map((item, i) => (
                      <div key={i} style={{ display: 'flex', gap: '0.5rem', marginBottom: '0.25rem' }}>
                        <span className={`badge badge-${item.type}`}>{item.type}</span>
                        <span>{item.message}</span>
                      </div>
                    ))}
                  </div>
                </div>
              )}

              {phase3Result && (
                <div>
                  <div style={{ display: 'flex', gap: '1rem', marginBottom: '1.5rem' }}>
                    <button
                      className="btn btn-secondary"
                      onClick={() => downloadCSV(
                        phase3Result.events,
                        'phase3_events.csv',
                        ['Case Master', 'A#', 'Hearing Date/Time', 'Event Type', 'Event Hearing Type', 'Court', 'Judge', 'MCH Attny', 'Bahr Client', '_summary']
                      )}
                    >
                      Download events.csv ({phase3Result.events.length})
                    </button>

                    <button
                      className="btn btn-secondary"
                      onClick={() => downloadCSV(
                        phase3Result.relationships,
                        'phase3_relationships.csv',
                        ['Case Master View', 'Object Client', 'Relationship', 'Bahr Client', '_contact_name', '_original_relationship']
                      )}
                    >
                      Download relationships.csv ({phase3Result.relationships.length})
                    </button>
                  </div>

                  {phase3Result.events.length > 0 && (
                    <div style={{ marginBottom: '1.5rem' }}>
                      <h4 style={{ marginBottom: '0.5rem' }}>Events Preview</h4>
                      <div className="table-container">
                        <table>
                          <thead>
                            <tr>
                              <th>Case Master (Record ID)</th>
                              <th>A#</th>
                              <th>Date/Time</th>
                              <th>Type</th>
                            </tr>
                          </thead>
                          <tbody>
                            {phase3Result.events.slice(0, 5).map((row, i) => (
                              <tr key={i}>
                                <td style={{ fontFamily: 'monospace', fontSize: '0.7rem' }}>{row['Case Master'] ? row['Case Master'].slice(0, 12) + '...' : '—'}</td>
                                <td>{row['A#']}</td>
                                <td>{row['Hearing Date/Time']?.slice(0, 16)}</td>
                                <td>{row['Event Hearing Type']}</td>
                              </tr>
                            ))}
                          </tbody>
                        </table>
                      </div>
                    </div>
                  )}

                  {phase3Result.relationships.length > 0 && (
                    <div>
                      <h4 style={{ marginBottom: '0.5rem' }}>Relationships Preview</h4>
                      <div className="table-container">
                        <table>
                          <thead>
                            <tr>
                              <th>Case Master View</th>
                              <th>Object Client</th>
                              <th>Relationship</th>
                              <th>Contact Name</th>
                            </tr>
                          </thead>
                          <tbody>
                            {phase3Result.relationships.slice(0, 5).map((row, i) => (
                              <tr key={i}>
                                <td style={{ fontFamily: 'monospace', fontSize: '0.7rem' }}>{row['Case Master View'] ? row['Case Master View'].slice(0, 12) + '...' : '—'}</td>
                                <td style={{ fontFamily: 'monospace', fontSize: '0.7rem' }}>{row['Object Client'] ? row['Object Client'].slice(0, 12) + '...' : '—'}</td>
                                <td>{row['Relationship']}</td>
                                <td>{row['_contact_name']}</td>
                              </tr>
                            ))}
                          </tbody>
                        </table>
                      </div>
                    </div>
                  )}
                </div>
              )}
            </div>
          )}
        </div>

        {/* Instructions */}
        <div className="card" style={{ marginTop: '1.5rem' }}>
          <h3 style={{ marginBottom: '1rem' }}>Import Order</h3>
          <div style={{ display: 'grid', gridTemplateColumns: 'repeat(3, 1fr)', gap: '1rem', fontSize: '0.875rem' }}>
            <div>
              <div style={{ color: '#6366f1', fontWeight: 600, marginBottom: '0.5rem' }}>Phase 1</div>
              <ol style={{ paddingLeft: '1.25rem', color: '#a1a1aa' }}>
                <li>Upload Bahr + Clio Contacts</li>
                <li>Download clients.csv</li>
                <li>Import to Airtable</li>
                <li>Export with Record IDs</li>
              </ol>
            </div>
            <div>
              <div style={{ color: '#a855f7', fontWeight: 600, marginBottom: '0.5rem' }}>Phase 2</div>
              <ol style={{ paddingLeft: '1.25rem', color: '#a1a1aa' }}>
                <li>Upload Airtable export + Clio Matters/Notes</li>
                <li>Download case_master_views.csv</li>
                <li>Import to Airtable</li>
                <li>Export with Record IDs</li>
              </ol>
            </div>
            <div>
              <div style={{ color: '#ec4899', fontWeight: 600, marginBottom: '0.5rem' }}>Phase 3</div>
              <ol style={{ paddingLeft: '1.25rem', color: '#a1a1aa' }}>
                <li>Upload both Airtable exports</li>
                <li>Upload Clio Events/Relationships</li>
                <li>Download events.csv & relationships.csv</li>
                <li>Import to Airtable</li>
              </ol>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
}

const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(<ClioAirtableMerger />);
  </script>
</body>
</html>
